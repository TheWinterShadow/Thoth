name: CD

on:
    release:
        types: [published]
    workflow_dispatch:

permissions:
    contents: read
    id-token: write

jobs:
    publish:
        name: "Publish to PyPI"
        runs-on: ubuntu-latest
        environment: release

        steps:
            - uses: actions/checkout@v4

            - name: Free disk space
              run: |
                  sudo rm -rf /usr/share/dotnet
                  sudo rm -rf /opt/ghc
                  sudo rm -rf /usr/local/share/boost
                  sudo apt-get clean
                  docker system prune -af

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Cache PyTorch
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: pytorch-cpu-${{ runner.os }}
                  restore-keys: |
                      pytorch-cpu-${{ runner.os }}-

            - name: Install Hatch
              run: |
                  python -m pip install --upgrade pip
                  pip install hatch

            - name: Install PyTorch CPU-only
              run: |
                  pip install torch --index-url https://download.pytorch.org/whl/cpu

            - name: Build package
              run: |
                  hatch build

            - name: Verify build artifacts
              run: |
                  ls -lh dist/
                  echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  ls -lh dist/ >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            # Uncomment when ready to publish to PyPI
            # - name: Publish to PyPI
            #   uses: pypa/gh-action-pypi-publish@release/v1
            #   with:
            #     repository-url: https://upload.pypi.org/legacy/
