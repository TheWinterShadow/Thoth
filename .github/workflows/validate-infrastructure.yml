name: "Secrets & Scheduler Validation"

on:
  workflow_dispatch:
    inputs:
      test_secrets:
        description: "Test Secret Manager integration"
        required: false
        default: "true"
      test_scheduler:
        description: "Test Cloud Scheduler jobs"
        required: false
        default: "true"
  schedule:
    # Run weekly validation on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: thoth-dev-485501
  GCP_REGION: us-central1

jobs:
  validate_secrets:
    name: "Validate Secret Manager Configuration"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_secrets != 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check Secrets Exist
        id: check_secrets
        run: |
          echo "## Secret Manager Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List of required secrets
          REQUIRED_SECRETS=("gitlab-token" "gitlab-url" "google-application-credentials")
          MISSING_SECRETS=()

          echo "### Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status | Versions |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          for secret in "${REQUIRED_SECRETS[@]}"; do
            if gcloud secrets describe "$secret" --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
              VERSION_COUNT=$(gcloud secrets versions list "$secret" --project=${{ env.GCP_PROJECT_ID }} --format="value(name)" | wc -l)
              echo "| \`$secret\` | ✅ Exists | $VERSION_COUNT |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`$secret\` | ❌ Missing | 0 |" >> $GITHUB_STEP_SUMMARY
              MISSING_SECRETS+=("$secret")
            fi
          done

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Missing secrets: ${MISSING_SECRETS[*]}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check IAM Permissions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### IAM Permissions Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SERVICE_ACCOUNT="thoth-mcp-sa@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

          # Check each secret's IAM policy
          for secret in gitlab-token gitlab-url google-application-credentials; do
            echo "#### Secret: \`$secret\`" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            gcloud secrets get-iam-policy "$secret" \
              --project=${{ env.GCP_PROJECT_ID }} \
              --filter="bindings.members:serviceAccount:$SERVICE_ACCOUNT" \
              --flatten="bindings[].members" \
              --format="table(bindings.role)" >> $GITHUB_STEP_SUMMARY || echo "No IAM bindings found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          done

      - name: Test Secret Access
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secret Access Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Try to access each secret (without revealing values)
          for secret in gitlab-token gitlab-url google-application-credentials; do
            if gcloud secrets versions access latest --secret="$secret" --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
              echo "- ✅ Successfully accessed \`$secret\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ Failed to access \`$secret\`" >> $GITHUB_STEP_SUMMARY
            fi
          done

  validate_scheduler:
    name: "Validate Cloud Scheduler Configuration"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scheduler != 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check Scheduler Jobs
        id: check_jobs
        run: |
          echo "## Cloud Scheduler Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List of expected jobs
          EXPECTED_JOBS=("thoth-daily-sync" "thoth-hourly-incremental-sync")
          MISSING_JOBS=()

          echo "### Scheduler Jobs" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Schedule | State | Last Run |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|-------|----------|" >> $GITHUB_STEP_SUMMARY

          for job in "${EXPECTED_JOBS[@]}"; do
            if gcloud scheduler jobs describe "$job" --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
              SCHEDULE=$(gcloud scheduler jobs describe "$job" --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} --format="value(schedule)")
              STATE=$(gcloud scheduler jobs describe "$job" --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} --format="value(state)")
              LAST_RUN=$(gcloud scheduler jobs describe "$job" --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} --format="value(lastAttemptTime)" || echo "Never")
              echo "| \`$job\` | ✅ Exists | \`$SCHEDULE\` | $STATE | $LAST_RUN |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`$job\` | ❌ Missing | - | - | - |" >> $GITHUB_STEP_SUMMARY
              MISSING_JOBS+=("$job")
            fi
          done

          if [ ${#MISSING_JOBS[@]} -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Missing scheduler jobs: ${MISSING_JOBS[*]}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check Scheduler Service Account
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scheduler Service Account" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SERVICE_ACCOUNT="thoth-scheduler@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

          if gcloud iam service-accounts describe "$SERVICE_ACCOUNT" --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
            echo "- ✅ Service account exists: \`$SERVICE_ACCOUNT\`" >> $GITHUB_STEP_SUMMARY
            
            # Check if it has Cloud Run invoker role
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### IAM Roles" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            gcloud run services get-iam-policy thoth-mcp-server \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.GCP_PROJECT_ID }} \
              --filter="bindings.members:serviceAccount:$SERVICE_ACCOUNT" \
              --flatten="bindings[].members" \
              --format="table(bindings.role)" >> $GITHUB_STEP_SUMMARY || echo "No IAM bindings found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Service account not found: \`$SERVICE_ACCOUNT\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test Scheduler Job Execution (Optional)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_scheduler == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Manual test execution skipped to avoid triggering sync." >> $GITHUB_STEP_SUMMARY
          echo "To test manually, run:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gcloud scheduler jobs run thoth-daily-sync --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  integration_test:
    name: "Integration Test"
    runs-on: ubuntu-latest
    needs: [validate_secrets, validate_scheduler]
    if: |
      always() &&
      (needs.validate_secrets.result == 'success' || needs.validate_secrets.result == 'skipped') &&
      (needs.validate_scheduler.result == 'success' || needs.validate_scheduler.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-secret-manager

      - name: Test Secret Manager Integration
        run: |
          python << 'EOF'
          import os
          from google.cloud import secretmanager

          project_id = "${{ env.GCP_PROJECT_ID }}"
          client = secretmanager.SecretManagerServiceClient()

          secrets = ["gitlab-token", "gitlab-url", "google-application-credentials"]

          print("## Integration Test Results")
          print()
          for secret_id in secrets:
              try:
                  name = f"projects/{project_id}/secrets/{secret_id}/versions/latest"
                  response = client.access_secret_version(request={"name": name})
                  # Don't print the actual value
                  print(f"✅ Successfully retrieved {secret_id}")
              except Exception as e:
                  print(f"❌ Failed to retrieve {secret_id}: {e}")
          EOF

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Ensure secrets have valid values" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitor scheduler job execution logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify Cloud Run service health" >> $GITHUB_STEP_SUMMARY
