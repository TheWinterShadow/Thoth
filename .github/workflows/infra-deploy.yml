name: "Infrastructure & Cloud Run Deploy"

on:
  push:
    branches:
      - main
    paths:
      - "terraform/**"
      - "thoth/**"
      - "Dockerfile.mcp"
      - "Dockerfile.ingestion"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:
    inputs:
      skip_terraform:
        description: "Skip Terraform deployment"
        required: false
        default: "false"
      skip_cloud_run:
        description: "Skip Cloud Run deployment"
        required: false
        default: "false"

permissions:
  contents: read
  id-token: write

env:
  TF_WORKING_DIR: ./terraform
  GCP_PROJECT_ID: thoth-dev-485501
  GCP_REGION: us-central1
  MCP_SERVICE_NAME: thoth-mcp-server
  INGESTION_SERVICE_NAME: thoth-ingestion-worker
  MCP_IMAGE_NAME: thoth-mcp
  INGESTION_IMAGE_NAME: thoth-ingestion
  TF_CLOUD_ORGANIZATION: TheWinterShadow
  TF_WORKSPACE: thoth-mcp-gcp

jobs:
  build_mcp_image:
    name: "Build and Push MCP Server Image"
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_cloud_run != 'true'
    outputs:
      image_tag: ${{ steps.image.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build MCP Docker Image
        run: |
          docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --cache-from gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:latest \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:${{ github.sha }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:latest \
            -f Dockerfile.mcp \
            .

      - name: Push MCP Docker Image
        run: |
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:latest

      - name: Set Output
        id: image
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

  build_ingestion_image:
    name: "Build and Push Ingestion Worker Image"
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_cloud_run != 'true'
    outputs:
      image_tag: ${{ steps.image.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build Ingestion Docker Image
        run: |
          docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --cache-from gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:latest \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:${{ github.sha }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:latest \
            -f Dockerfile.ingestion \
            .

      - name: Push Ingestion Docker Image
        run: |
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:latest

      - name: Set Output
        id: image
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

  terraform:
    name: "Provision Infrastructure"
    runs-on: ubuntu-latest
    needs: [build_mcp_image, build_ingestion_image]
    if: |
      always() &&
      (needs.build_mcp_image.result == 'success' || needs.build_mcp_image.result == 'skipped') &&
      (needs.build_ingestion_image.result == 'success' || needs.build_ingestion_image.result == 'skipped') &&
      github.event.inputs.skip_terraform != 'true'
    outputs:
      bucket_name: ${{ steps.outputs.outputs.bucket_name }}
      mcp_service_url: ${{ steps.outputs.outputs.mcp_service_url }}
      ingestion_worker_url: ${{ steps.outputs.outputs.ingestion_worker_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: 1.5.7

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -var-file=environments/dev.tfvars
          echo "## Terraform Plan" >> $GITHUB_STEP_SUMMARY
          echo "Plan URL: https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/${{ env.TF_WORKSPACE }}/runs" >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: terraform apply -auto-approve -var-file=environments/dev.tfvars
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get Terraform Outputs
        id: outputs
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          BUCKET_NAME=$(terraform output -raw storage_bucket_name 2>/dev/null || echo "thoth-dev-485501-thoth-storage")
          MCP_URL=$(terraform output -raw mcp_service_url 2>/dev/null || echo "")
          INGESTION_URL=$(terraform output -raw ingestion_worker_url 2>/dev/null || echo "")
          echo "bucket_name=${BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "mcp_service_url=${MCP_URL}" >> $GITHUB_OUTPUT
          echo "ingestion_worker_url=${INGESTION_URL}" >> $GITHUB_OUTPUT
          echo "## ðŸ“ Terraform Cloud Deployment" >> $GITHUB_STEP_SUMMARY
          echo "View run details: https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/${{ env.TF_WORKSPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- MCP Service URL: ${MCP_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- Ingestion Worker URL: ${INGESTION_URL}" >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ env.TF_WORKING_DIR }}

  # Update Cloud Run images after Terraform deployment
  # Note: Terraform manages all Cloud Run configuration (env vars, secrets, IAM).
  # This job ONLY updates the container image, preserving Terraform-managed settings.
  update_cloud_run_images:
    name: "Update Cloud Run Images"
    runs-on: ubuntu-latest
    needs: [build_mcp_image, build_ingestion_image, terraform]
    if: |
      always() &&
      (needs.terraform.result == 'success' || needs.terraform.result == 'skipped') &&
      (needs.build_mcp_image.result == 'success' || needs.build_mcp_image.result == 'skipped') &&
      (needs.build_ingestion_image.result == 'success' || needs.build_ingestion_image.result == 'skipped') &&
      github.event.inputs.skip_cloud_run != 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Only update the image - preserves all Terraform-managed configuration
      - name: Update MCP Server Image
        id: update_mcp
        run: |
          gcloud run services update ${{ env.MCP_SERVICE_NAME }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.MCP_IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }}

      - name: Update Ingestion Worker Image
        id: update_ingestion
        run: |
          gcloud run services update ${{ env.INGESTION_SERVICE_NAME }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.INGESTION_IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }}

      - name: Get Service URLs
        id: urls
        run: |
          MCP_URL=$(gcloud run services describe ${{ env.MCP_SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          INGESTION_URL=$(gcloud run services describe ${{ env.INGESTION_SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "mcp_url=$MCP_URL" >> $GITHUB_OUTPUT
          echo "ingestion_url=$INGESTION_URL" >> $GITHUB_OUTPUT
          echo "## Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "- **MCP Server URL**: $MCP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Ingestion Worker URL**: $INGESTION_URL" >> $GITHUB_STEP_SUMMARY

      - name: Verify MCP Server Deployment
        run: |
          SERVICE_URL="${{ steps.urls.outputs.mcp_url }}"
          echo "Waiting for MCP server to be ready..."
          sleep 10

          # Health check requires authentication - use gcloud identity token
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
            "${SERVICE_URL}/health" || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "âœ… MCP Server health check passed!"
            echo "### MCP Server Health Check: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  MCP Server health check returned status: $HEALTH_STATUS"
            echo "### MCP Server Health Check: âš ï¸  Status $HEALTH_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Ingestion Worker Deployment
        run: |
          SERVICE_URL="${{ steps.urls.outputs.ingestion_url }}"
          echo "Waiting for ingestion worker to be ready..."
          sleep 10

          # Health check requires authentication - use gcloud identity token
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
            "${SERVICE_URL}/health" || echo "000")

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "âœ… Ingestion Worker health check passed!"
            echo "### Ingestion Worker Health Check: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Ingestion Worker health check returned status: $HEALTH_STATUS"
            echo "### Ingestion Worker Health Check: âš ï¸  Status $HEALTH_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Infrastructure Components
        run: |
          echo "### Infrastructure Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check secrets
          echo "#### Secrets (Secret Manager)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gcloud secrets list --project=${{ env.GCP_PROJECT_ID }} --filter="name~gitlab OR name~huggingface" --format="table(name,createTime)" >> $GITHUB_STEP_SUMMARY || echo "No secrets found"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check Cloud Tasks queues
          echo "#### Cloud Tasks Queues" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gcloud tasks queues list --location=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} --format="table(name,rateLimits.maxConcurrentDispatches,state)" >> $GITHUB_STEP_SUMMARY || echo "No queues found"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
