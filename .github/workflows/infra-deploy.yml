name: "Infrastructure & Lambda Deploy"

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - "thoth/**"
      - "lambda/**"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:
    inputs:
      skip_terraform:
        description: "Skip Terraform deployment"
        required: false
        default: "false"
      skip_lambda:
        description: "Skip Lambda deployment"
        required: false
        default: "false"

permissions:
  contents: read
  id-token: write

env:
  TF_WORKING_DIR: ./infra
  AWS_REGION: us-east-1
  ENVIRONMENT: dev

jobs:
  terraform:
    name: "Provision Infrastructure"
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_terraform != 'true'
    outputs:
      api_url: ${{ steps.outputs.outputs.api_url }}
      lambda_function_name: ${{ steps.outputs.outputs.lambda_function_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Bootstrap Terraform State
        run: |
          cd bootstrap
          if ! aws s3 ls s3://thoth-terraform-state &>/dev/null; then
            echo "State bucket doesn't exist. Running Terraform bootstrap..."
            terraform init
            terraform apply -auto-approve -input=false \
              -var="region=${{ env.AWS_REGION }}" \
              -var="environment=${{ env.ENVIRONMENT }}"
            echo "Bootstrap complete."
          else
            echo "State bucket already exists. Skipping bootstrap."
          fi
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="bucket=thoth-terraform-state" \
            -backend-config="key=terraform/state" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=thoth-terraform-state-lock"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -out=tfplan \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="environment=${{ env.ENVIRONMENT }}"
          echo "## Terraform Plan" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          terraform show -no-color tfplan >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: terraform apply -auto-approve -input=false tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get Terraform Outputs
        id: outputs
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          API_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")
          LAMBDA_NAME=$(terraform output -raw lambda_function_name 2>/dev/null || echo "")
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "lambda_function_name=${LAMBDA_NAME}" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }}

  build_and_deploy_lambda:
    name: "Build and Deploy Lambda"
    runs-on: ubuntu-latest
    needs: terraform
    if: |
      always() &&
      (needs.terraform.result == 'success' || needs.terraform.result == 'skipped') &&
      github.event.inputs.skip_lambda != 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Container Image
        env:
          ECR_REPOSITORY: thoth-mcp
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG -f lambda/Dockerfile .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
          docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest

      - name: Update Lambda Function
        run: |
          FUNCTION_NAME=$(terraform output -raw refresh_lambda_function_name)
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --image-uri ${{ steps.login-ecr.outputs.registry }}/thoth-mcp:${{ github.sha }} \
            --region ${{ env.AWS_REGION }}

      - name: Verify Deployment
        run: |
          API_URL="${{ needs.terraform.outputs.api_url }}"
          if [ -n "$API_URL" ]; then
            echo "## Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
            echo "API URL: $API_URL" >> $GITHUB_STEP_SUMMARY
          fi
