openapi: 3.1.0
info:
  title: Thoth API
  description: |
    API specification for Thoth services:
    - **MCP Server**: Model Context Protocol server for AI assistants with multi-collection search
    - **Ingestion Worker**: Document processing and embedding pipeline with job tracking
  version: 2.0.0
  contact:
    name: TheWinterShadow
    url: https://github.com/TheWinterShadow/Thoth

servers:
  - url: https://thoth-mcp-server-{hash}-uc.a.run.app
    description: MCP Server (Cloud Run)
  - url: https://thoth-ingestion-worker-{hash}-uc.a.run.app
    description: Ingestion Worker (Cloud Run)

tags:
  - name: MCP Server
    description: Model Context Protocol endpoints
  - name: Ingestion
    description: Document ingestion endpoints
  - name: Jobs
    description: Job status and management
  - name: Health
    description: Health check endpoints

paths:
  # ============================================================================
  # Health Endpoints
  # ============================================================================
  /:
    get:
      tags: [Health]
      summary: Root health check
      description: Simple health check for load balancer probes
      operationId: rootHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health:
    get:
      tags: [Health]
      summary: Detailed health status
      description: Returns detailed health status including component checks
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'

  # ============================================================================
  # MCP Server Endpoints
  # ============================================================================
  /sse:
    get:
      tags: [MCP Server]
      summary: SSE connection for MCP protocol
      description: |
        Establishes a Server-Sent Events connection for MCP protocol communication.
        Clients send requests via POST /messages and receive responses through this stream.
      operationId: sseConnect
      responses:
        '200':
          description: SSE stream established
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE event stream

  /messages:
    post:
      tags: [MCP Server]
      summary: Send MCP message
      description: |
        Send an MCP protocol message. Responses are delivered via the SSE connection.

        **Supported MCP methods:**
        - `tools/list` - List available tools
        - `tools/call` - Execute a tool
        - `resources/list` - List available resources
        - `resources/read` - Read a resource

        **Available Tools:**
        - `ping` - Simple connectivity test
        - `search_documents` - Search across multiple document collections
        - `search_handbook` - Legacy search (handbook only, backward compatible)
      operationId: sendMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MCPRequest'
            examples:
              listTools:
                summary: List available tools
                value:
                  jsonrpc: "2.0"
                  id: 1
                  method: "tools/list"
              searchDocuments:
                summary: Search across collections
                value:
                  jsonrpc: "2.0"
                  id: 2
                  method: "tools/call"
                  params:
                    name: "search_documents"
                    arguments:
                      query: "onboarding process"
                      sources: ["handbook", "dnd"]
                      n_results: 10
              searchHandbookLegacy:
                summary: Search handbook (legacy)
                value:
                  jsonrpc: "2.0"
                  id: 3
                  method: "tools/call"
                  params:
                    name: "search_handbook"
                    arguments:
                      query: "code review guidelines"
                      n_results: 5
      responses:
        '202':
          description: Message accepted, response via SSE
        '400':
          description: Invalid request format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================================
  # Ingestion Worker Endpoints
  # ============================================================================
  /clone-handbook:
    post:
      tags: [Ingestion]
      summary: Clone handbook repository to GCS
      description: |
        Clones the GitLab handbook repository and uploads it to Google Cloud Storage.
        This is typically a one-time setup operation for the handbook source.
      operationId: cloneHandbook
      security:
        - cloudIdentity: []
      responses:
        '200':
          description: Repository cloned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloneResponse'
        '400':
          description: GCS not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Clone operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ingest:
    post:
      tags: [Ingestion]
      summary: Start ingestion job
      description: |
        Creates an ingestion job for the specified source. Returns immediately with a job_id
        for status tracking. The actual processing runs in the background.

        **Supported Sources:**
        - `handbook` - GitLab handbook (Markdown files)
        - `dnd` - D&D materials (Markdown, PDF, text files)
        - `personal` - Personal documents (Markdown, PDF, text, Word files)

        **Supported File Formats:**
        - `.md`, `.markdown`, `.mdown` - Markdown with YAML frontmatter
        - `.pdf` - PDF documents (via PyMuPDF)
        - `.txt` - Plain text files
        - `.docx` - Word documents (via python-docx)
      operationId: startIngestion
      security:
        - cloudIdentity: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
            examples:
              handbook:
                summary: Ingest handbook
                value:
                  source: handbook
              dndForce:
                summary: Force re-ingest D&D materials
                value:
                  source: dnd
                  force: true
              personal:
                summary: Ingest personal documents
                value:
                  source: personal
      responses:
        '202':
          description: Job created and processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestResponse'
        '400':
          description: Invalid or missing source parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to create job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ingest-batch:
    post:
      tags: [Ingestion]
      summary: Process file batch
      description: |
        Processes a specific batch of files. Called by Cloud Tasks for parallel processing.
        Each batch is processed independently and stored to a unique GCS prefix.
        Use `/merge-batches` to consolidate after all batches complete.
      operationId: processBatch
      security:
        - cloudIdentity: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
            example:
              start_index: 0
              end_index: 100
              collection_name: handbook_documents
              batch_id: "0_100_abc123"
      responses:
        '200':
          description: Batch processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Batch processing failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /merge-batches:
    post:
      tags: [Ingestion]
      summary: Merge batch LanceDB tables
      description: |
        Consolidates all batch LanceDB tables into the main store (gs://bucket/lancedb).
        Call this endpoint after all batch tasks have completed.
      operationId: mergeBatches
      security:
        - cloudIdentity: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeBatchesRequest'
            example:
              collection_name: handbook_documents
              cleanup: true
      responses:
        '200':
          description: Batches merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeBatchesResponse'
        '400':
          description: GCS not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Merge operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================================
  # Job Management Endpoints
  # ============================================================================
  /jobs:
    get:
      tags: [Jobs]
      summary: List ingestion jobs
      description: |
        Returns a list of recent ingestion jobs with optional filtering.
        Jobs are sorted by start time (most recent first).
      operationId: listJobs
      security:
        - cloudIdentity: []
      parameters:
        - name: source
          in: query
          description: Filter by source name
          schema:
            type: string
            enum: [handbook, dnd, personal]
        - name: status
          in: query
          description: Filter by job status
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: limit
          in: query
          description: Maximum number of jobs to return
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: List of jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobListResponse'
        '500':
          description: Failed to list jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{job_id}:
    get:
      tags: [Jobs]
      summary: Get job status
      description: |
        Returns the current status of an ingestion job including progress statistics.
      operationId: getJobStatus
      security:
        - cloudIdentity: []
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job identifier (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '400':
          description: Missing job_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to get job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    cloudIdentity:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Google Cloud Identity token (obtained via `gcloud auth print-identity-token`)

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, healthy, unhealthy]
          example: healthy

    DetailedHealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        checks:
          type: object
          properties:
            vector_store:
              type: string
              enum: [ok, error]
            embedder:
              type: string
              enum: [ok, error]
            gcs:
              type: string
              enum: [ok, error]
        timestamp:
          type: string
          format: date-time

    MCPRequest:
      type: object
      required: [jsonrpc, id, method]
      properties:
        jsonrpc:
          type: string
          const: "2.0"
        id:
          oneOf:
            - type: integer
            - type: string
        method:
          type: string
          enum:
            - tools/list
            - tools/call
            - resources/list
            - resources/read
        params:
          type: object

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: "Description of the error"

    CloneResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        files_uploaded:
          type: integer
          example: 1234
        gcs_path:
          type: string
          example: gs://bucket/handbook/

    IngestRequest:
      type: object
      required: [source]
      properties:
        source:
          type: string
          enum: [handbook, dnd, personal]
          description: Source identifier
        force:
          type: boolean
          default: false
          description: Force full re-ingestion (ignores incremental updates)

    IngestResponse:
      type: object
      properties:
        status:
          type: string
          example: accepted
        job_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        source:
          type: string
          example: handbook
        collection_name:
          type: string
          example: handbook_documents
        message:
          type: string
          example: "Ingestion job created. Use GET /jobs/{job_id} to check status."

    BatchRequest:
      type: object
      required: [start_index, end_index]
      properties:
        start_index:
          type: integer
          description: Start index in file list
        end_index:
          type: integer
          description: End index in file list
        file_list:
          type: array
          items:
            type: string
          description: Optional list of specific file paths to process
        collection_name:
          type: string
          default: handbook_documents
          description: Target collection name
        batch_id:
          type: string
          description: Unique batch identifier (auto-generated if not provided)

    BatchResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        batch_id:
          type: string
          example: "0_100_abc123"
        gcs_prefix:
          type: string
          example: "lancedb_batch_handbook_documents_0_100_abc123"
        files_processed:
          type: integer
        chunks_created:
          type: integer
        errors:
          type: array
          items:
            type: object
            properties:
              file:
                type: string
              error:
                type: string

    MergeBatchesRequest:
      type: object
      properties:
        collection_name:
          type: string
          default: handbook_documents
          description: Collection to merge batches into
        cleanup:
          type: boolean
          default: true
          description: Delete batch prefixes from GCS after merging

    MergeBatchesResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        collection_name:
          type: string
          example: handbook_documents
        batches_merged:
          type: integer
          example: 10
        total_documents:
          type: integer
          example: 5000
        batches_cleaned:
          type: integer
          example: 10
        final_gcs_prefix:
          type: string
          example: "gs://bucket/lancedb"

    JobStats:
      type: object
      properties:
        total_files:
          type: integer
          example: 1000
        processed_files:
          type: integer
          example: 950
        failed_files:
          type: integer
          example: 5
        total_chunks:
          type: integer
          example: 5000
        total_documents:
          type: integer
          example: 4500

    Job:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        source:
          type: string
          enum: [handbook, dnd, personal]
        collection_name:
          type: string
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        stats:
          $ref: '#/components/schemas/JobStats'
        error:
          type: string
          nullable: true
          description: Error message if status is 'failed'

    JobListResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        count:
          type: integer
          example: 10
